#!/usr/bin/env python3\n\"\"\"\næµ‹è¯• Streamlit æ•°æ®åŠ è½½ä¿®å¤\n\"\"\"\n\nimport pandas as pd\nfrom pathlib import Path\nfrom tools.ga4_data_parser import GA4DataParser\nfrom tools.data_storage_manager import DataStorageManager\n\ndef test_streamlit_data_fix():\n    \"\"\"æµ‹è¯• Streamlit æ•°æ®åŠ è½½ä¿®å¤\"\"\"\n    try:\n        print(\"ğŸ”§ æµ‹è¯• Streamlit æ•°æ®åŠ è½½ä¿®å¤...\")\n        \n        # 1. æ¨¡æ‹Ÿ Streamlit çš„æ•°æ®å¤„ç†æµç¨‹\n        data_file = Path(\"data/events_ga4.ndjson\")\n        parser = GA4DataParser()\n        raw_data = parser.parse_ndjson(str(data_file))\n        print(f\"âœ… è§£æäº† {len(raw_data)} ä¸ªåŸå§‹äº‹ä»¶\")\n        \n        # 2. æå–äº‹ä»¶æ•°æ®ï¼ˆæ¨¡æ‹Ÿ main.py ä¸­çš„é€»è¾‘ï¼‰\n        events_data = parser.extract_events(raw_data)\n        user_data = parser.extract_user_properties(raw_data)\n        session_data = parser.extract_sessions(raw_data)\n        \n        print(f\"äº‹ä»¶æ•°æ®ç±»å‹: {type(events_data)}\")\n        \n        # 3. å¤„ç†äº‹ä»¶æ•°æ®ï¼ˆä½¿ç”¨ä¿®å¤åçš„é€»è¾‘ï¼‰\n        if isinstance(events_data, dict):\n            # åˆå¹¶æ‰€æœ‰äº‹ä»¶ç±»å‹çš„æ•°æ®\n            all_events_list = []\n            for event_type, event_df in events_data.items():\n                if not event_df.empty:\n                    all_events_list.append(event_df)\n                    print(f\"  æ·»åŠ  {event_type}: {len(event_df)} ä¸ªäº‹ä»¶\")\n            \n            if all_events_list:\n                combined_events = pd.concat(all_events_list, ignore_index=True)\n                print(f\"âœ… åˆå¹¶äº† {len(events_data)} ç§äº‹ä»¶ç±»å‹ï¼Œæ€»è®¡ {len(combined_events)} ä¸ªäº‹ä»¶\")\n            else:\n                combined_events = pd.DataFrame()\n                print(\"âš ï¸ æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„äº‹ä»¶æ•°æ®\")\n        else:\n            combined_events = events_data\n        \n        # 4. å­˜å‚¨æ•°æ®ï¼ˆæ¨¡æ‹Ÿ Streamlit çš„å­˜å‚¨é€»è¾‘ï¼‰\n        storage_manager = DataStorageManager()\n        storage_manager.store_events(combined_events)\n        storage_manager.store_users(user_data)\n        storage_manager.store_sessions(session_data)\n        \n        # 5. éªŒè¯å­˜å‚¨çš„æ•°æ®\n        stored_events = storage_manager.get_data('events')\n        if stored_events is not None and not stored_events.empty:\n            print(f\"âœ… å­˜å‚¨éªŒè¯æˆåŠŸï¼Œäº‹ä»¶æ•°: {len(stored_events)}\")\n            print(f\"äº‹ä»¶ç±»å‹: {stored_events['event_name'].unique()[:5]}\")\n            \n            # 6. æµ‹è¯•åˆ†æå¼•æ“æ¥å£\n            from engines.event_analysis_engine import EventAnalysisEngine\n            from engines.retention_analysis_engine import RetentionAnalysisEngine\n            \n            print(\"\\nğŸ§ª æµ‹è¯•åˆ†æå¼•æ“æ¥å£...\")\n            \n            # æµ‹è¯•äº‹ä»¶åˆ†æ\n            event_engine = EventAnalysisEngine(storage_manager)\n            event_result = event_engine.analyze_events(stored_events)\n            print(f\"âœ… äº‹ä»¶åˆ†ææˆåŠŸï¼Œç»“æœç±»å‹: {type(event_result)}\")\n            print(f\"äº‹ä»¶åˆ†æçŠ¶æ€: {event_result.get('status', 'unknown')}\")\n            \n            # æµ‹è¯•ç•™å­˜åˆ†æ\n            retention_engine = RetentionAnalysisEngine(storage_manager)\n            retention_result = retention_engine.analyze_retention(stored_events)\n            print(f\"âœ… ç•™å­˜åˆ†ææˆåŠŸï¼Œç»“æœç±»å‹: {type(retention_result)}\")\n            print(f\"ç•™å­˜åˆ†æçŠ¶æ€: {retention_result.get('status', 'unknown')}\")\n            \n        else:\n            print(\"âŒ å­˜å‚¨éªŒè¯å¤±è´¥ï¼Œæ•°æ®ä¸ºç©º\")\n            return False\n        \n        print(\"\\nğŸ‰ Streamlit æ•°æ®åŠ è½½ä¿®å¤æµ‹è¯•æˆåŠŸï¼\")\n        return True\n        \n    except Exception as e:\n        print(f\"âŒ æµ‹è¯•å¤±è´¥: {e}\")\n        import traceback\n        traceback.print_exc()\n        return False\n\nif __name__ == \"__main__\":\n    test_streamlit_data_fix()"